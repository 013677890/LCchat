## 微服务分拆方案（IM/仿微信）

### 1) 接入层：Connect Service（网关/长连接）
- 协议：TCP / WebSocket
- 职责：维护与客户端的长连接，心跳检测/踢掉死链，协议解析（拆包、解包，将二进制转 Protobuf），只做消息转发，不读写数据库。
- 特点：有状态（Stateful），内存占用高，CPU 占用低，可按连接数水平扩展，需会话粘性或一致性哈希。

### 2) 接口层：API Gateway（HTTP 接口）
- 协议：HTTP / RESTful / GraphQL
- 职责：面向 Web/Vue 前端的常规接口；注册、登录、修改头像、获取好友列表、获取历史消息等。
- 特点：无状态，易于水平扩展，可前置网关做限流与鉴权。

### 3) 业务逻辑层 A：User RPC（用户服务）
- 协议：gRPC
- 职责：账号管理（验证 Token、注册逻辑）、关系链（添加好友、拉黑、群成员管理）。
- 数据：强依赖 MySQL（主从/分库分表预留），可加 Redis 做热数据缓存。

### 4) 业务逻辑层 B：Msg RPC（消息服务）
- 协议：gRPC + MQ（Kafka / RocketMQ）
- 职责：消息落地（MongoDB 或 MySQL），消息路由（单聊/群聊投递），写扩散/读扩散策略，未读计数/回执。
- 数据：依赖 Redis（热点缓存、去重、未读计数）与 DB（持久化）。

### 后续可扩展的服务
- 群组服务：建群、成员管理、权限模型、群公告。
- 推送/离线服务：未读同步、离线拉取、移动端推送（APNs/FCM）。
- 文件与媒体：头像/图片/语音/视频上传，生成带签名 URL，防盗链。
- 审计与风控：敏感词、频控、黑名单、操作审计。
- 观测与运维：日志、指标、链路追踪；自动扩缩容、灰度发布。




```
graph TD
    Client((客户端 App/Web))

    subgraph "接入层 (保持长连接)"
    %% 修复点：加上双引号 "..."
    Connect["apps/connect (WS/TCP)"]
    end

    subgraph "接口层 (无状态)"
    %% 修复点：加上双引号 "..."
    API["apps/gateway (HTTP)"]
    end

    subgraph "中间件"
    Kafka{Kafka / Redpanda}
    Redis[(Redis)]
    DB[(数据库)] 
    end

    subgraph "业务服务 (RPC)"
    User[apps/user]
    Msg[apps/chat]
    end

    %% 发送消息流程 (HTTP)
    Client -- 1. POST /send --> API
    API -- 2. Produce --> Kafka
    API -- 3. Ack (200 OK) --> Client

    %% 消息处理流程
    Kafka -- 4. Consume --> Msg
    Msg -- 5. Store/Logic --> Redis & DB

    %% 消息推送流程 (WebSocket)
    Msg -- 6. Find Receiver's Node --> Redis
    Msg -- 7. RPC Push --> Connect
    Connect -- 8. Push Message --> Client
```